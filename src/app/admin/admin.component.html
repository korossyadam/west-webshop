<div class="content-container">
   <div class="content-inner-container">

      <mat-card class="product-card">

         <!-- Add Products -->
         <p>Termék hozzáadása</p>
         <button mat-raised-button color="primary" (click)="openProductDialog()">Új termék hozzáadása</button>

         <!-- Update Products -->
         <p>Termék frissítése</p>
         <div class="update-button-container">
            <input placeholder="A termék pontos cikkszáma" #updatePartNumber>
            <button mat-raised-button color="primary" (click)="attemptToOpenUpdateDialog(updatePartNumber.value)">Megnyitás</button>
         </div>

         <!-- Delete Products -->
         <p>Termék törlése</p>
         <div class="update-button-container">
            <input placeholder="A termék pontos cikkszáma" #deletePartNumber>
            <button mat-raised-button color="warn" (click)="openDeleteProductDialog(deletePartNumber.value)">Törlés</button>
         </div>
      </mat-card>

      <!-- Offers section -->
      <mat-card class="offer-card">
         <p>Árajánlat kérések</p>

         <!-- Date picker -->
         <mat-form-field appearance="fill" class="datepicker-container" color="primary">
            <mat-label>Keresési intervallum</mat-label>
            <mat-date-range-input [formGroup]="offerRange" [rangePicker]="appointmentPicker">
               <input matStartDate formControlName="start" placeholder="Kezdő időpont">
               <input matEndDate formControlName="end" placeholder="Végső időpont">
            </mat-date-range-input>
            <mat-hint>MM/DD/YYYY – MM/DD/YYYY</mat-hint>
            <mat-datepicker-toggle matSuffix [for]="appointmentPicker"></mat-datepicker-toggle>
            <mat-date-range-picker #appointmentPicker></mat-date-range-picker>

            <mat-error *ngIf="offerRange.controls.start.hasError('matStartDateInvalid')">Helytelen kezdő időpont</mat-error>
            <mat-error *ngIf="offerRange.controls.end.hasError('matEndDateInvalid')">Helytelen végső időpont</mat-error>
         </mat-form-field>

         <!-- Checkbox and query button -->
         <div class="offer-input-container">
            <div>
               <mat-checkbox #unAnswered>Csak válaszolatlanok</mat-checkbox>
            </div>
            <button mat-raised-button class="offer-query-button" color="primary" (click)="queryForOffers(offerRange.value['start'], offerRange.value['end'], unAnswered.checked)">Lekérdezés</button>
         </div>

         <!-- Offer table -->
         <table mat-table [dataSource]="offers" class="offer-table">

            <!-- Date Column -->
            <ng-container matColumnDef="date">
               <th mat-header-cell *matHeaderCellDef>Dátum</th>
               <td mat-cell *matCellDef="let element">{{ element.date.toDate().toLocaleString() }}</td>
            </ng-container>

            <!-- Email Column -->
            <ng-container matColumnDef="email">
               <th mat-header-cell *matHeaderCellDef>E-mail cím</th>
               <td mat-cell *matCellDef="let element">{{ element.email }}</td>
            </ng-container>

            <!-- Answered Column -->
            <ng-container matColumnDef="answered">
               <th mat-header-cell *matHeaderCellDef>Státusz</th>
               <td mat-cell *matCellDef="let element">{{ getAnsweredState(element.answered) }}</td>
            </ng-container>

            <!-- Action Column -->
            <ng-container matColumnDef="action">
               <th mat-header-cell *matHeaderCellDef>Megnyitás</th>
               <td mat-cell *matCellDef="let element">
                  <button mat-raised-button color="primary" (click)="openOfferDialog(element)">Megnyitás</button>
               </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="offerColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: offerColumns;"></tr>
         </table>

      </mat-card>

      <!-- Orders section -->
      <mat-card class="order-card">
         <p>Rendelések</p>

         <!-- Date picker -->
         <mat-form-field appearance="fill" class="datepicker-container" color="primary">
            <mat-label>Keresési intervallum</mat-label>
            <mat-date-range-input [formGroup]="offerRange" [rangePicker]="orderPicker">
               <input matStartDate formControlName="start" placeholder="Kezdő időpont">
               <input matEndDate formControlName="end" placeholder="Végső időpont">
            </mat-date-range-input>
            <mat-hint>MM/DD/YYYY – MM/DD/YYYY</mat-hint>
            <mat-datepicker-toggle matSuffix [for]="orderPicker"></mat-datepicker-toggle>
            <mat-date-range-picker #orderPicker></mat-date-range-picker>

            <mat-error *ngIf="orderRange.controls.start.hasError('matStartDateInvalid')">Helytelen kezdő időpont</mat-error>
            <mat-error *ngIf="orderRange.controls.end.hasError('matEndDateInvalid')">Helytelen végső időpont</mat-error>
         </mat-form-field>

         <!-- Query button -->
         <div class="offer-input-container">
            <button mat-raised-button class="offer-query-button" color="primary" (click)="queryForOrders(orderRange.value['start'], orderRange.value['end'])">Lekérdezés</button>
         </div>

         <!-- Order table -->
         <table mat-table [dataSource]="orders" class="offer-table">

            <!-- Date Column -->
            <ng-container matColumnDef="date">
               <th mat-header-cell *matHeaderCellDef>Dátum</th>
               <td mat-cell *matCellDef="let element">{{ element.date.toDate().toLocaleString() }}</td>
            </ng-container>

            <!-- Email Column -->
            <ng-container matColumnDef="email">
               <th mat-header-cell *matHeaderCellDef>E-mail cím</th>
               <td mat-cell *matCellDef="let element">{{ element.shippingAddress.email }}</td>
            </ng-container>

            <!-- Price Column -->
            <ng-container matColumnDef="price">
               <th mat-header-cell *matHeaderCellDef>Végösszeg</th>
               <td mat-cell *matCellDef="let element">{{ formatPrice(addTax(element.totalPrice)) }}</td>
            </ng-container>

            <!-- Action Column -->
            <ng-container matColumnDef="action">
               <th mat-header-cell *matHeaderCellDef>Megnyitás</th>
               <td mat-cell *matCellDef="let element">
                  <button mat-raised-button color="primary" (click)="openOrderDialog(element)">Megnyitás</button>
               </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="orderColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: orderColumns;"></tr>
         </table>
      </mat-card>

      <!-- Dev card -->
      <mat-card class="dev-card">
         <p>Fejlesztői műveletek</p>

         <div class="dev-section">
            <p>Termékek</p>
            <button mat-raised-button (click)="uploadProductsFromTextFile()" color="primary">Termékek feltöltése szöveges fájlból</button>
         </div>

         <div class="dev-section">
            <p>AP Termékek</p>
            <button mat-raised-button (click)="addUncategoriedProducts()" color="primary">AP Termékek feltöltése</button>
            <button mat-raised-button (click)="categorizeProduct()" color="primary">Következő termék kategorizálása</button>
         </div>

      </mat-card>

   </div>
</div>


<!-- Dialog that opens when we want to upload a new Product -->
<ng-template #newProductDialogRef let-product class="product-dialog">
   <p *ngIf="product" class="dialog-title">Termék módosítása</p>
   <p *ngIf="!product" class="dialog-title">Új termék hozzáadása</p>
   <mat-divider class="dialog-divider"></mat-divider>


   <!-- Body -->
   <div mat-dialog-content>

      
      <!-- Basic info -->
      <div>
         <p class="section-title">Alapvető adatok</p>
         <input placeholder="Cikkszám" [value]="product ? product.partNumber : ''" #partNumber>
         <input placeholder="Név" [value]="product ? product.name : ''" #name>
         <input placeholder="Leírás" [value]="product ? product.description : ''" #description>
         <input placeholder="Márka" [value]="product ? product.brand : ''" #brand>
         <input placeholder="Nettó ár" [value]="product ? product.price : ''" #price>
         <input placeholder="Raktár mennyisége" [value]="product ? product.stock : ''" #stock>
         <mat-checkbox [checked]="product ? product.returnable : true" #returnable>Visszaküldhető</mat-checkbox><br>
         <mat-divider class="section-divider"></mat-divider>
      </div>


      <!-- Categories -->
      <div>
         <p class="section-title">Kategoriák</p>
         <button mat-raised-button (click)="addSpecialCategory()">Kategória hozzáadása</button><br>

         <!-- Lopp through every category selector input -->
         <ng-container *ngFor="let categorySelector of specialCategoryInputs; let i = index;">

            <select #specialCategory [(ngModel)]="specialCategoryInputs[i]" [ngModelOptions]="{standalone: true}">
               <option value="-1">Nincs</option>
               <option *ngFor="let category of categories; let j = index;">{{ (j+1) + '. ' + category }}</option>
            </select>

         </ng-container>
         <mat-divider class="section-divider"></mat-divider>
      </div>

      
      <!-- Images -->
      <div>
         <p class="section-title">Képek</p>
         <div *ngIf="product">
            <div *ngFor="let imgurl of activeImageUrls; let i = index;">
               <img [src]="sanitize(imgurl)" width="100" height="100">
               <mat-icon class="delete-img-button" (click)="deleteImage(i)">close</mat-icon>
            </div>
         </div>
         <input type="file" multiple (change)="onFileChange($event)" #images><br>
      </div>

   </div>

   <p *ngIf="productFormError != ''" class="error-text">{{ productFormError }}</p>

   <!-- Buttons -->
   <button mat-raised-button class="dialog-close-button" mat-dialog-close>Vissza</button>
   <button *ngIf="!product" mat-raised-button class="dialog-ok-button" color="primary" (click)="addNewProduct(partNumber.value, name.value, description.value, brand.value, price.value, stock.value, returnable.checked)">Termék feltöltése</button>
   <button *ngIf="product" mat-raised-button class="dialog-ok-button" color="primary" (click)="updateProduct(product, product.id, partNumber.value, name.value, description.value, brand.value, price.value, stock.value, returnable.checked)">Termék módosítása</button>

</ng-template>


<!-- Dialog that opens when we want to delete a Product -->
<ng-template #deleteProductDialogRef let-product>
   <p class="dialog-title">Termék törlése</p>

   <!-- Body -->
   <p class="offer-row">Biztosan ki akarod törölni ezt a terméket?</p>

   <!-- Buttons -->
   <button mat-raised-button class="dialog-close-button" mat-dialog-close>Vissza</button>
   <button mat-raised-button class="dialog-ok-button" color="warn" mat-dialog-close (click)="deleteProduct(product.id)">Törlés</button>
</ng-template>


<!-- Dialog that opens when we want to answer an Offer -->
<ng-template #offerDialogRef let-offer>
   <p class="dialog-title">Válaszadás egy árajánlatra</p>
   <mat-divider class="dialog-divider"></mat-divider>

   <!-- Body -->
   <p class="offer-row"><span class="underlined">Gyártmány:</span> {{ offer.brand }}</p>
   <p class="offer-row"><span class="underlined">Évjárat:</span> {{ offer.year }}</p>
   <p class="offer-row"><span class="underlined">Motor:</span> {{ offer.engine }}</p>
   <p class="offer-row"><span class="underlined">Karosszéria:</span> {{ offer.chassis }}</p>
   <p class="offer-row"><span class="underlined">Klímaberendezés:</span> {{ offer.ac }}</p>
   <p class="offer-row"><span class="underlined">Alvázszám:</span> {{ offer.vin }}</p>
   <p class="offer-row"><span class="underlined">Üzenet:</span> {{ offer.message }}</p>
   <textarea placeholder="Válaszüzenet..." #answer></textarea>

   <!-- Buttons -->
   <button mat-raised-button class="dialog-close-button" mat-dialog-close>Vissza</button>
   <button mat-raised-button class="dialog-ok-button" color="primary" mat-dialog-close (click)="answerOffer(offer, answer.value)">Válaszadás</button>
</ng-template>


<!-- Dialog that opens when inspecting an Order -->
<ng-template #orderDialogRef let-order>
   <p class="dialog-title">Rendelés: {{ timestampToDate(order.date).toLocaleString() }}</p>
   <div *ngIf="order">

      <!-- List all products in the Order-->
      <table class="table">
         <thead>
            <th>Megnevezés</th>
            <th>Mennyiség</th>
            <th>Ár</th>
         </thead>

         <tbody>
            <tr *ngFor="let product of order.orderedProducts">

               <td class="info-column">
                  <div class="info-container">
                     <p [routerLink]="['/product', product.partNumber]" class="part-number" mat-dialog-close>{{ product.partNumber }}</p>
                     <p class="name">{{ product.name }}</p>
                     <p class="brand">{{ product.brand }}</p>
                  </div>
               </td>

               <td class="amount-column">
                  <p>{{ product.quantity }} db.</p>
               </td>

               <td class="price-column">
                  <div class="price-container">
                     <p class="price">{{ formatPrice(addTax(product.price)) }}</p>
                     <p class="net-price">({{ formatPrice(product.price) }} + 27% ÁFA)</p>
                  </div>
               </td>

            </tr>

            <tr class="total-row">
               <td></td>
               <td></td>
               <td class="price-column total-column">
                  <div class="price-container">
                     <p>Szállítás: {{ formatPrice(order.deliveryPrice) }}</p>
                     <p>Végösszeg: {{ formatPrice(addTax(order.totalPrice)) }}</p>
                  </div>
               </td>
            </tr>

         </tbody>
      </table>

      <mat-divider></mat-divider>

      <!-- Other information about the Order-->
      <div>
         <div class="quarter-container">
            <p class="quarter-title">Alap adatok</p>
            <div class="quarter-text-container">
               <p>{{ order.shippingAddress.name }}</p>
               <p>{{ order.shippingAddress.email }}</p>
               <p>{{ order.shippingAddress.phoneNumber }}</p>
               <p>{{ order.shippingAddress.address }}</p>
               <p *ngIf="order.shippingAddress.comment">{{ order.shippingAddress.comment }}</p>
            </div>
         </div>

         <div class="quarter-container">
            <p class="quarter-title">Számlázási adatok</p>
            <div class="quarter-text-container">
               <p>{{ order.billingAddress.name }}</p>
               <p>{{ order.billingAddress.address }}</p>
               <p *ngIf="order.billingAddress.taxNumber">{{ order.billingAddress.taxNumber }}</p>
            </div>
         </div>

         <div class="quarter-container">
            <p class="quarter-title">Átvétel</p>
            <div class="quarter-text-container">
               <p>Házhozszállítás</p>
            </div>
         </div>

         <div class="quarter-container">
            <p class="quarter-title">Fizetés</p>
            <div class="quarter-text-container">
               <p>Utánvét</p>
            </div>
         </div>
      </div>

   </div>
   <button mat-raised-button class="dialog-close-button" color="primary" mat-dialog-close>Vissza</button>
</ng-template>